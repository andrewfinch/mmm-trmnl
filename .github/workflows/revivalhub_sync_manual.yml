name: Sync RevivalHub to TRMNL (Manual)

on:
  workflow_dispatch:

jobs:
  manual:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      REVIVALHUB_URL: ${{ secrets.REVIVALHUB_URL }}
      TRMNL_API_KEY: ${{ secrets.TRMNL_API_KEY }}
      TRMNL_PLUGIN_ID: ${{ secrets.TRMNL_PLUGIN_ID }}
      TRMNL_BASE_URL: ${{ secrets.TRMNL_BASE_URL }}
      REVIVALHUB_THEATRE: ${{ vars.REVIVALHUB_THEATRE }}
      REVIVALHUB_TIMEZONE: ${{ vars.REVIVALHUB_TIMEZONE }}
      REVIVALHUB_LOOKAHEAD_HOURS: ${{ vars.REVIVALHUB_LOOKAHEAD_HOURS }}
      REVIVALHUB_SHOW_QR: ${{ vars.REVIVALHUB_SHOW_QR }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Build payload (dry run)
        env:
          REVIVALHUB_URL: ${{ env.REVIVALHUB_URL }}
        run: |
          set -euo pipefail
          python src/revivalhub_trmnl_sync.py \
            --revivalhub-url "${REVIVALHUB_URL}" \
            --theatre "${REVIVALHUB_THEATRE:-new beverly}" \
            --timezone "${REVIVALHUB_TIMEZONE:-America/Los_Angeles}" \
            --lookahead-hours "${REVIVALHUB_LOOKAHEAD_HOURS:-96}" \
            --trmnl-mode plugin --dry-run \
            --trmnl-base-url "${TRMNL_BASE_URL:-https://api.usetrmnl.com}" \
            --verbose \
            --payload-path payload.json

      - name: Upload via Python (normal path)
        id: py_upload
        continue-on-error: true
        env:
          REVIVALHUB_URL: ${{ env.REVIVALHUB_URL }}
        run: |
          set -euo pipefail
          python src/revivalhub_trmnl_sync.py \
            --revivalhub-url "${REVIVALHUB_URL}" \
            --theatre "${REVIVALHUB_THEATRE:-new beverly}" \
            --timezone "${REVIVALHUB_TIMEZONE:-America/Los_Angeles}" \
            --lookahead-hours "${REVIVALHUB_LOOKAHEAD_HOURS:-96}" \
            --trmnl-mode plugin \
            --trmnl-base-url "${TRMNL_BASE_URL:-https://api.usetrmnl.com}" \
            --verbose

      - name: Fallback upload via curl (DNS bypass)
        id: fallback_upload
        if: steps.py_upload.outcome == 'failure'
        env:
          REVIVALHUB_URL: ${{ env.REVIVALHUB_URL }}
        run: |
          set -euo pipefail
          # Rebuild payload to ensure payload.json exists and is non-empty
          python src/revivalhub_trmnl_sync.py \
            --revivalhub-url "${REVIVALHUB_URL}" \
            --theatre "${REVIVALHUB_THEATRE:-new beverly}" \
            --timezone "${REVIVALHUB_TIMEZONE:-America/Los_Angeles}" \
            --lookahead-hours "${REVIVALHUB_LOOKAHEAD_HOURS:-96}" \
            --trmnl-mode plugin --dry-run \
            --trmnl-base-url "${TRMNL_BASE_URL:-https://api.usetrmnl.com}" \
            --payload-path payload.json
          # Wrap the built payload for Plugin Data API
          python - << 'PY'
import json
data=json.load(open("payload.json","r",encoding="utf-8"))
json.dump({"data": data}, open("plugin_body.json","w",encoding="utf-8"))
PY
          # Build host/endpoint candidates from TRMNL_BASE_URL (or sensible defaults)
          META=$(python - << 'PY'
import os, json, sys, urllib.parse
base=os.environ.get("TRMNL_BASE_URL","").strip()
plugin_id=os.environ.get("TRMNL_PLUGIN_ID","")
if not base:
    hosts=["api.usetrmnl.com","api.trmnl.app"]
    print(json.dumps({"hosts":hosts,"scheme":"https","endpoint":f"/v1/plugins/{plugin_id}/data"})); sys.exit(0)
base=base.rstrip("/")
u=urllib.parse.urlparse(base if "://" in base else "https://"+base)
host=u.netloc or u.path
scheme=u.scheme or "https"
prefix=u.path if u.netloc else ""
endpoint=f"{prefix}/v1/plugins/{plugin_id}/data"
print(json.dumps({"hosts":[host],"scheme":scheme,"endpoint":endpoint}))
PY
)
          echo "$META" > meta.json
          SCHEME=$(python -c 'import json;print(json.load(open("meta.json")).get("scheme","https"))' || echo "https")
          ENDPOINT=$(python -c 'import json;print(json.load(open("meta.json"))["endpoint"])')
          python - << 'PY'
import json
m=json.load(open("meta.json"))
open("hosts.txt","w").write("\n".join(m.get("hosts",[])))
PY
          echo "Trying hosts:"
          cat hosts.txt

          # Try each host with DoH + curl --resolve
          OK=0
          while IFS= read -r HOST; do
            echo "Resolving ${HOST} via DoH..."
            IP=$(curl -sS -H 'accept: application/dns-json' \
              "https://cloudflare-dns.com/dns-query?name=${HOST}&type=A" \
              | python - << 'PY'
import json,sys
try:
  d=json.load(sys.stdin)
  ans=[a.get("data") for a in d.get("Answer",[]) if a.get("type")==1]
  print(ans[0] if ans else "")
except Exception:
  print("")
PY
)
            if [ -z "$IP" ]; then
              echo "No A record from DoH for ${HOST}; skipping."
              continue
            fi
            echo "Resolved ${HOST} -> ${IP}; posting..."
            set +e
            HTTP=$(curl -sS -o /tmp/resp.txt -w "%{http_code}" -X POST "${SCHEME}://${HOST}${ENDPOINT}" \
              --resolve "${HOST}:443:${IP}" \
              -H "Authorization: Bearer ${TRMNL_API_KEY}" \
              -H "Content-Type: application/json" \
              --data @plugin_body.json)
            RC=$?
            set -e
            echo "HTTP status: $HTTP (rc=$RC)"
            if [ "$RC" -eq 0 ] && [ "$HTTP" -ge 200 ] && [ "$HTTP" -lt 300 ]; then
              echo "Upload succeeded via ${HOST}"
              OK=1
              break
            else
              echo "Upload failed via ${HOST}; first 200 bytes of response:"
              head -c 200 /tmp/resp.txt || true
              echo
            fi
          done < hosts.txt
          if [ "$OK" -ne 1 ]; then
            echo "All upload attempts failed."
            exit 1
          fi

      - name: Upload payload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trmnl-payload
          path: payload.json


