name: Sync RevivalHub to TRMNL

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

concurrency:
  group: revivalhub-sync-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    permissions:
      contents: read
      pages: write
      id-token: write
    env:
      REVIVALHUB_URL: ${{ secrets.REVIVALHUB_URL }}
      REVIVALHUB_THEATRE: ${{ vars.REVIVALHUB_THEATRE }}
      REVIVALHUB_TIMEZONE: ${{ vars.REVIVALHUB_TIMEZONE }}
      REVIVALHUB_LOOKAHEAD_HOURS: ${{ vars.REVIVALHUB_LOOKAHEAD_HOURS }}
      REVIVALHUB_SHOW_QR: ${{ vars.REVIVALHUB_SHOW_QR }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Build payload (dry run)
        env:
          REVIVALHUB_URL: ${{ env.REVIVALHUB_URL }}
        run: |
          set -euo pipefail
          python src/revivalhub_trmnl_sync.py \
            --revivalhub-url "${REVIVALHUB_URL}" \
            --theatre "${REVIVALHUB_THEATRE:-new beverly}" \
            --timezone "${REVIVALHUB_TIMEZONE:-America/Los_Angeles}" \
            --lookahead-hours "${REVIVALHUB_LOOKAHEAD_HOURS:-96}" \
            --trmnl-mode plugin --dry-run \
            --verbose \
            --payload-path payload.json

      # Golden path: publish payload.json for TRMNL Webhooks (pull model)

      - name: Upload payload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trmnl-payload
          path: payload.json

      - name: Prepare Pages artifact
        if: always()
        run: |
          set -euo pipefail
          mkdir -p site
          cp payload.json site/payload.json
          python - <<'PY'
import json, pathlib
payload = json.load(open('payload.json'))
# Also publish a wrapped body that matches Plugin Data API shape and flips on debug overlay
wrapped = {"data": payload, "debug": True}
pathlib.Path('site/plugin_body.json').write_text(json.dumps(wrapped, indent=2))
PY

      - name: Upload Pages artifact
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        if: always()
        id: deployment
        uses: actions/deploy-pages@v4

