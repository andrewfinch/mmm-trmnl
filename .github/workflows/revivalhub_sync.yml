name: Sync RevivalHub to TRMNL

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

concurrency:
  group: revivalhub-sync-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      REVIVALHUB_URL: ${{ secrets.REVIVALHUB_URL }}
      TRMNL_API_KEY: ${{ secrets.TRMNL_API_KEY }}
      TRMNL_PLUGIN_ID: ${{ secrets.TRMNL_PLUGIN_ID }}
      REVIVALHUB_THEATRE: ${{ vars.REVIVALHUB_THEATRE }}
      REVIVALHUB_TIMEZONE: ${{ vars.REVIVALHUB_TIMEZONE }}
      REVIVALHUB_LOOKAHEAD_HOURS: ${{ vars.REVIVALHUB_LOOKAHEAD_HOURS }}
      REVIVALHUB_SHOW_QR: ${{ vars.REVIVALHUB_SHOW_QR }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Build payload (dry run)
        env:
          REVIVALHUB_URL: ${{ env.REVIVALHUB_URL }}
        run: |
          set -euo pipefail
          python src/revivalhub_trmnl_sync.py \
            --revivalhub-url "${REVIVALHUB_URL}" \
            --theatre "${REVIVALHUB_THEATRE:-new beverly}" \
            --timezone "${REVIVALHUB_TIMEZONE:-America/Los_Angeles}" \
            --lookahead-hours "${REVIVALHUB_LOOKAHEAD_HOURS:-96}" \
            --trmnl-mode plugin --dry-run \
            --verbose \
            --payload-path payload.json

      - name: Upload via Python (normal path)
        id: py_upload
        continue-on-error: true
        env:
          REVIVALHUB_URL: ${{ env.REVIVALHUB_URL }}
        run: |
          set -euo pipefail
          python src/revivalhub_trmnl_sync.py \
            --revivalhub-url "${REVIVALHUB_URL}" \
            --theatre "${REVIVALHUB_THEATRE:-new beverly}" \
            --timezone "${REVIVALHUB_TIMEZONE:-America/Los_Angeles}" \
            --lookahead-hours "${REVIVALHUB_LOOKAHEAD_HOURS:-96}" \
            --trmnl-mode plugin \
            --verbose

      - name: Fallback upload via curl (DNS bypass)
        id: fallback_upload
        if: steps.py_upload.outcome == 'failure'
        env:
          REVIVALHUB_URL: ${{ env.REVIVALHUB_URL }}
        run: |
          set -euo pipefail
          # Wrap the built payload for Plugin Data API
          python - << 'PY'
          import json,sys
          with open("payload.json","r",encoding="utf-8") as f:
              data=json.load(f)
          with open("plugin_body.json","w",encoding="utf-8") as f:
              json.dump({"data":data}, f)
          PY
          # Resolve api.usetrmnl.com via Cloudflare DoH to bypass runner DNS
          IP=$(curl -sH 'accept: application/dns-json' \
            'https://cloudflare-dns.com/dns-query?name=api.usetrmnl.com&type=A' \
            | python - << 'PY'
          import json,sys
          d=json.load(sys.stdin)
          ans=[a.get("data") for a in d.get("Answer",[]) if a.get("type")==1]
          print(ans[0] if ans else "")
          PY
          )
          if [ -z "$IP" ]; then
            echo "No A record returned from DoH; cannot fallback."
            exit 1
          fi
          # Post using resolved IP while keeping Host/SNI via --resolve
          curl -fsS -X POST "https://api.usetrmnl.com/v1/plugins/${TRMNL_PLUGIN_ID}/data" \
            --resolve "api.usetrmnl.com:443:${IP}" \
            -H "Authorization: Bearer ${TRMNL_API_KEY}" \
            -H "Content-Type: application/json" \
            --data @plugin_body.json -i

      - name: Upload payload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trmnl-payload
          path: payload.json

